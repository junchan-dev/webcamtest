<!doctype html>
<html>
<head>
    <title>Self Camera</title>
        <!-- bulma -->
        <link rel="stylesheet" href="./bulma/bulma.css">
        <script defer src="./bulma/all.js"></script>
        <!-- jquery 
        <script src="./jquery/jquery-3.3.1.js"></script> -->
        <!-- jquery -->
        <script src="./jsQR/jsQR.js"></script>
        </head>
<body>
    <section class="section has-background-primary">
        <h3 class="title">QRコードのテスト実施</h3>
        <div class="container">
            <div class="box">
                    <div class="columns">
                        <div class="column">
                            <button id='BtnStart' class='button is-rounded'>撮影開始</button>
                        </div>
                        <div class="column">
                            <button id='BtnReadCode' class='button is-rounded'>認識開始</button>
                        </div>
                    </div>
            </div>
            <div class="box">
                <div class="columns">
                    <div class="column">
                        <video id="myVideo" width="400" height="300" autoplay="1"></video>
                    </div>
                    <div class="column">
                        <canvas id="canvas" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="box">
                
                <input class="input" id="ReadResult" type="text" placeholder="読取結果">
            </div>
    </section>

    <script type="text/javascript">
    var instance =  document.querySelector("video");
    document.addEventListener('DOMContentLoaded',function(){
        document.querySelector('#BtnStart').addEventListener('click', function() {
            let p = navigator.mediaDevices.getUserMedia({ audio: false, video: {facingMode: 'environment'}});
            p.then(function (mediaStream) {
                instance.srcObject = mediaStream;
            })
        })
        document.querySelector('#BtnReadCode').addEventListener('click', function() {
            //let canv = document.createElement("canvas");
            //canv.height = this.height;
            //canv.width = this.width;
            let canv = document.querySelector("canvas");
            const context = canv.getContext("2d");
            context.drawImage(instance, 0, 0, instance.width, instance.height);
            const imageData = context.getImageData(0, 0, instance.width, instance.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
                document.querySelector("#ReadResult").value = "Found QR code" + " " + code + " " + code.data
            }
            else {
                document.querySelector("#ReadResult").value = "not found";
            }
        })
    });
    </script>
</body>

</html>
